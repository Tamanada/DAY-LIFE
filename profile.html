<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DAYLIFE â€” Profile</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <!-- Top bar -->
  <header class="topbar">
    <div class="logo">
      <img src="assets/logo.png" alt="DAYLIFE Logo" />
      <span>DAYLIFE</span>
    </div>
    <nav class="desktop-nav">
      <a href="home.html">ğŸ  Home</a>
      <a href="dreams.html">ğŸ’­ Dreams</a>
      <a href="reflections.html">ğŸª Reflections</a>
      <a href="profile.html" class="active">ğŸ‘¤ Profile</a>
    </nav>
  </header>

  <main class="profile-page">
    <!-- Header -->
    <section class="profile-header">
      <h1>Profil</h1>
      <p>Votre parcours en un coup d'Å“il.</p>
    </section>

    <!-- Profile Card -->
    <section class="profile-card">
      <div class="avatar-wrapper" id="avatarWrapper">
        <img id="profileAvatar" src="assets/avatar.png" alt="Avatar" />
        <div class="avatar-edit">Change</div>
        <input type="file" id="avatarInput" accept="image/*" hidden />
      </div>

      <div class="profile-main-text">
        <h2 id="profileName">Votre nom</h2>
        <p id="profileEmail" class="muted">Votre email</p>
      </div>

      <div class="profile-badges">
        <div class="badge badge-stars">
          <span class="emoji">â­</span>
          <span id="profileStars">0</span>
          <small>Ã©toiles</small>
        </div>
        <div class="badge badge-streak" id="streakBadge" style="display:none">
          <span class="emoji">ğŸ”¥</span>
          <span id="profileStreak">0</span>
          <small>jours de suite</small>
        </div>
      </div>
    </section>

    <!-- Stats grid -->
    <section class="profile-stats-grid">
      <div class="stat-card">
        <div class="icon-circle blue">ğŸ¯</div>
        <h3 id="activeDreamsCount">0</h3>
        <p>RÃªves actifs</p>
      </div>
      <div class="stat-card">
        <div class="icon-circle green">âœ…</div>
        <h3 id="completedDreamsCount">0</h3>
        <p>RÃªves accomplis</p>
      </div>
      <div class="stat-card">
        <div class="icon-circle purple">ğŸ“”</div>
        <h3 id="reflectionsCount">0</h3>
        <p>RÃ©flexions</p>
      </div>
    </section>

    <!-- Referral Section -->
    <section class="referral-card">
      <div class="referral-header">
        <h3>Share & Earn Stars</h3>
        <p>Invite friends and earn <strong>+5 â­</strong> for each friend who joins!</p>
      </div>

      <div class="referral-stats">
        <div class="ref-box">
          <div class="icon-circle purple">ğŸ‘¥</div>
          <h3 id="refFriends">0</h3>
          <p>Friends Joined</p>
        </div>
        <div class="ref-box">
          <div class="icon-circle yellow">â­</div>
          <h3 id="refStars">0</h3>
          <p>Stars Earned</p>
        </div>
      </div>

      <div class="referral-link-block">
        <label>Your Referral Link</label>
        <div class="referral-input-row">
          <input type="text" id="referralLinkInput" readonly />
          <button id="copyReferralBtn">Copy</button>
        </div>
        <button id="shareReferralBtn" class="primary-btn full-width">
          Share with Friends
        </button>
      </div>

      <p class="tiny-text">
        When someone joins using your link and completes setup, you both earn bonus stars!
      </p>
    </section>

    <!-- Settings -->
    <section class="settings-card">
      <h3>ParamÃ¨tres</h3>

      <div class="setting-group">
        <label for="nameInput">Nom affichÃ©</label>
        <input type="text" id="nameInput" placeholder="Votre nom" />
      </div>

      <div class="setting-group">
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" placeholder="vous@example.com" />
      </div>

      <div class="setting-group">
        <label for="birthInput">Date de naissance</label>
        <input type="date" id="birthInput" />
        <small>UtilisÃ©e pour calculer votre parcours de vie.</small>
      </div>

      <div class="setting-group">
        <label for="sexSelect">Sexe</label>
        <select id="sexSelect">
          <option value="male">Homme</option>
          <option value="female">Femme</option>
        </select>
        <small>UtilisÃ© pour calculer l'espÃ©rance de vie rÃ©elle.</small>
      </div>

      <div class="setting-group">
        <label for="countrySelect">Pays de naissance</label>
        <select id="countrySelect"></select>
        <small>UtilisÃ© pour ajuster l'espÃ©rance de vie selon les statistiques.</small>
      </div>

      <div class="setting-group">
        <label for="lifeModeSelect">MÃ©thode de calcul de vie</label>
        <select id="lifeModeSelect">
          <option value="30000_days">30 000 jours (par dÃ©faut)</option>
          <option value="by_demographics">RÃ©el (selon mon profil)</option>
        </select>
        <small id="lifeModeHint"></small>
      </div>

      <div class="setting-group">
        <label for="themeSelect">ThÃ¨me</label>
        <select id="themeSelect">
          <option value="light">Clair (recommandÃ©)</option>
          <option value="dark">Sombre</option>
          <option value="lunar">Lunaire</option>
        </select>
      </div>

      <div class="logout-row">
        <button id="logoutBtn" class="danger-btn full-width">
          Se dÃ©connecter
        </button>
      </div>
    </section>
  </main>

  <footer id="mobileNav"></footer>
  <script src="assets/nav.js"></script>

  <script>
    createNavBar("profile");

    // --- Country list (codes + noms FR) ---
    const countries = [
      { code: "AF", name: "Afghanistan" },
      { code: "ZA", name: "Afrique du Sud" },
      { code: "AL", name: "Albanie" },
      { code: "DZ", name: "AlgÃ©rie" },
      { code: "DE", name: "Allemagne" },
      { code: "AD", name: "Andorre" },
      { code: "AO", name: "Angola" },
      { code: "SA", name: "Arabie Saoudite" },
      { code: "AR", name: "Argentine" },
      { code: "AM", name: "ArmÃ©nie" },
      { code: "AU", name: "Australie" },
      { code: "AT", name: "Autriche" },
      { code: "AZ", name: "AzerbaÃ¯djan" },
      { code: "BS", name: "Bahamas" },
      { code: "BH", name: "BahreÃ¯n" },
      { code: "BD", name: "Bangladesh" },
      { code: "BB", name: "Barbade" },
      { code: "BE", name: "Belgique" },
      { code: "BZ", name: "Belize" },
      { code: "BJ", name: "BÃ©nin" },
      { code: "BT", name: "Bhoutan" },
      { code: "BY", name: "BiÃ©lorussie" },
      { code: "BO", name: "Bolivie" },
      { code: "BA", name: "Bosnie-HerzÃ©govine" },
      { code: "BW", name: "Botswana" },
      { code: "BR", name: "BrÃ©sil" },
      { code: "BN", name: "Brunei" },
      { code: "BG", name: "Bulgarie" },
      { code: "BF", name: "Burkina Faso" },
      { code: "BI", name: "Burundi" },
      { code: "KH", name: "Cambodge" },
      { code: "CM", name: "Cameroun" },
      { code: "CA", name: "Canada" },
      { code: "CV", name: "Cap-Vert" },
      { code: "CL", name: "Chili" },
      { code: "CN", name: "Chine" },
      { code: "CY", name: "Chypre" },
      { code: "CO", name: "Colombie" },
      { code: "KM", name: "Comores" },
      { code: "CG", name: "Congo" },
      { code: "KR", name: "CorÃ©e du Sud" },
      { code: "KP", name: "CorÃ©e du Nord" },
      { code: "CR", name: "Costa Rica" },
      { code: "CI", name: "CÃ´te d'Ivoire" },
      { code: "HR", name: "Croatie" },
      { code: "CU", name: "Cuba" },
      { code: "DK", name: "Danemark" },
      { code: "DJ", name: "Djibouti" },
      { code: "DM", name: "Dominique" },
      { code: "EG", name: "Ã‰gypte" },
      { code: "AE", name: "Ã‰mirats Arabes Unis" },
      { code: "EC", name: "Ã‰quateur" },
      { code: "ER", name: "Ã‰rythrÃ©e" },
      { code: "ES", name: "Espagne" },
      { code: "EE", name: "Estonie" },
      { code: "US", name: "Ã‰tats-Unis" },
      { code: "ET", name: "Ã‰thiopie" },
      { code: "FJ", name: "Fidji" },
      { code: "FI", name: "Finlande" },
      { code: "FR", name: "France" },
      { code: "GA", name: "Gabon" },
      { code: "GM", name: "Gambie" },
      { code: "GE", name: "GÃ©orgie" },
      { code: "GH", name: "Ghana" },
      { code: "GR", name: "GrÃ¨ce" },
      { code: "GD", name: "Grenade" },
      { code: "GT", name: "Guatemala" },
      { code: "GN", name: "GuinÃ©e" },
      { code: "GQ", name: "GuinÃ©e Ã©quatoriale" },
      { code: "GW", name: "GuinÃ©e-Bissau" },
      { code: "GY", name: "Guyana" },
      { code: "HT", name: "HaÃ¯ti" },
      { code: "HN", name: "Honduras" },
      { code: "HU", name: "Hongrie" },
      { code: "IN", name: "Inde" },
      { code: "ID", name: "IndonÃ©sie" },
      { code: "IQ", name: "Irak" },
      { code: "IR", name: "Iran" },
      { code: "IE", name: "Irlande" },
      { code: "IS", name: "Islande" },
      { code: "IL", name: "IsraÃ«l" },
      { code: "IT", name: "Italie" },
      { code: "JM", name: "JamaÃ¯que" },
      { code: "JP", name: "Japon" },
      { code: "JO", name: "Jordanie" },
      { code: "KZ", name: "Kazakhstan" },
      { code: "KE", name: "Kenya" },
      { code: "KG", name: "Kirghizistan" },
      { code: "KI", name: "Kiribati" },
      { code: "KW", name: "KoweÃ¯t" },
      { code: "LA", name: "Laos" },
      { code: "LS", name: "Lesotho" },
      { code: "LV", name: "Lettonie" },
      { code: "LB", name: "Liban" },
      { code: "LR", name: "Liberia" },
      { code: "LY", name: "Libye" },
      { code: "LI", name: "Liechtenstein" },
      { code: "LT", name: "Lituanie" },
      { code: "LU", name: "Luxembourg" },
      { code: "MK", name: "MacÃ©doine du Nord" },
      { code: "MG", name: "Madagascar" },
      { code: "MY", name: "Malaisie" },
      { code: "MW", name: "Malawi" },
      { code: "MV", name: "Maldives" },
      { code: "ML", name: "Mali" },
      { code: "MT", name: "Malte" },
      { code: "MA", name: "Maroc" },
      { code: "MH", name: "Ãles Marshall" },
      { code: "MU", name: "Maurice" },
      { code: "MR", name: "Mauritanie" },
      { code: "MX", name: "Mexique" },
      { code: "FM", name: "MicronÃ©sie" },
      { code: "MD", name: "Moldavie" },
      { code: "MC", name: "Monaco" },
      { code: "MN", name: "Mongolie" },
      { code: "ME", name: "MontÃ©nÃ©gro" },
      { code: "MZ", name: "Mozambique" },
      { code: "MM", name: "Myanmar" },
      { code: "NA", name: "Namibie" },
      { code: "NR", name: "Nauru" },
      { code: "NP", name: "NÃ©pal" },
      { code: "NI", name: "Nicaragua" },
      { code: "NE", name: "Niger" },
      { code: "NG", name: "Nigeria" },
      { code: "NO", name: "NorvÃ¨ge" },
      { code: "NZ", name: "Nouvelle-ZÃ©lande" },
      { code: "OM", name: "Oman" },
      { code: "UG", name: "Ouganda" },
      { code: "UZ", name: "OuzbÃ©kistan" },
      { code: "PK", name: "Pakistan" },
      { code: "PW", name: "Palaos" },
      { code: "PA", name: "Panama" },
      { code: "PG", name: "Papouasie-Nouvelle-GuinÃ©e" },
      { code: "PY", name: "Paraguay" },
      { code: "NL", name: "Pays-Bas" },
      { code: "PE", name: "PÃ©rou" },
      { code: "PH", name: "Philippines" },
      { code: "PL", name: "Pologne" },
      { code: "PT", name: "Portugal" },
      { code: "QA", name: "Qatar" },
      { code: "DO", name: "RÃ©publique Dominicaine" },
      { code: "CD", name: "RÃ©publique DÃ©mocratique du Congo" },
      { code: "CZ", name: "RÃ©publique TchÃ¨que" },
      { code: "RO", name: "Roumanie" },
      { code: "GB", name: "Royaume-Uni" },
      { code: "RU", name: "Russie" },
      { code: "RW", name: "Rwanda" },
      { code: "KN", name: "Saint-Christophe-et-NiÃ©vÃ¨s" },
      { code: "SM", name: "Saint-Marin" },
      { code: "VC", name: "Saint-Vincent-et-les-Grenadines" },
      { code: "LC", name: "Sainte-Lucie" },
      { code: "SV", name: "Salvador" },
      { code: "WS", name: "Samoa" },
      { code: "ST", name: "Sao TomÃ©-et-Principe" },
      { code: "SN", name: "SÃ©nÃ©gal" },
      { code: "RS", name: "Serbie" },
      { code: "SC", name: "Seychelles" },
      { code: "SL", name: "Sierra Leone" },
      { code: "SG", name: "Singapour" },
      { code: "SK", name: "Slovaquie" },
      { code: "SI", name: "SlovÃ©nie" },
      { code: "SO", name: "Somalie" },
      { code: "SD", name: "Soudan" },
      { code: "SS", name: "Soudan du Sud" },
      { code: "LK", name: "Sri Lanka" },
      { code: "SE", name: "SuÃ¨de" },
      { code: "CH", name: "Suisse" },
      { code: "SR", name: "Suriname" },
      { code: "SY", name: "Syrie" },
      { code: "TJ", name: "Tadjikistan" },
      { code: "TZ", name: "Tanzanie" },
      { code: "TD", name: "Tchad" },
      { code: "TH", name: "ThaÃ¯lande" },
      { code: "TL", name: "Timor oriental" },
      { code: "TG", name: "Togo" },
      { code: "TO", name: "Tonga" },
      { code: "TT", name: "TrinitÃ©-et-Tobago" },
      { code: "TN", name: "Tunisie" },
      { code: "TM", name: "TurkmÃ©nistan" },
      { code: "TR", name: "Turquie" },
      { code: "TV", name: "Tuvalu" },
      { code: "UA", name: "Ukraine" },
      { code: "UY", name: "Uruguay" },
      { code: "VU", name: "Vanuatu" },
      { code: "VA", name: "Vatican" },
      { code: "VE", name: "Venezuela" },
      { code: "VN", name: "Vietnam" },
      { code: "YE", name: "YÃ©men" },
      { code: "ZM", name: "Zambie" },
      { code: "ZW", name: "Zimbabwe" }
    ];

    // Populate country select
    const countrySelect = document.getElementById("countrySelect");
    countries.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.code;
      opt.textContent = c.name;
      countrySelect.appendChild(opt);
    });

    // Default profile structure
    const defaultProfile = {
      name: "David",
      email: "",
      avatar: "assets/avatar.png",
      totalStars: 0,
      streakDays: 0,
      birthdate: "",
      sex: "male",
      country: "",
      lifeMode: "30000_days",
      theme: "light",
      referralCode: null,
      referralFriends: 0
    };

    let profile = JSON.parse(localStorage.getItem("profile")) || defaultProfile;

    if (!profile.referralCode) {
      profile.referralCode = "DAY" + Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    function saveProfile() {
      localStorage.setItem("profile", JSON.stringify(profile));
    }

    function updateLifeModeHint() {
      const hint = document.getElementById("lifeModeHint");
      if (profile.lifeMode === "by_demographics") {
        const countryObj = countries.find(c => c.code === profile.country);
        const sexLabel = profile.sex === "male" ? "hommes" : "femmes";
        const countryName = countryObj ? countryObj.name : "votre pays";
        hint.textContent = `BasÃ© sur les donnÃ©es d'espÃ©rance de vie pour les ${sexLabel} en ${countryName}.`;
      } else {
        hint.textContent = "BasÃ© sur une vie moyenne de 30 000 jours.";
      }
    }

    function renderProfile() {
      // avatar
      const avatarImg = document.getElementById("profileAvatar");
      avatarImg.src = profile.avatar || "assets/avatar.png";

      // main text
      document.getElementById("profileName").textContent = profile.name || "Votre nom";
      document.getElementById("profileEmail").textContent = profile.email || "Votre email";

      // badges
      document.getElementById("profileStars").textContent = profile.totalStars || 0;
      const streakBadge = document.getElementById("streakBadge");
      if (profile.streakDays && profile.streakDays > 0) {
        streakBadge.style.display = "flex";
        document.getElementById("profileStreak").textContent = profile.streakDays;
      } else {
        streakBadge.style.display = "none";
      }

      // settings inputs
      document.getElementById("nameInput").value = profile.name || "";
      document.getElementById("emailInput").value = profile.email || "";
      document.getElementById("birthInput").value = profile.birthdate || "";
      document.getElementById("sexSelect").value = profile.sex || "male";
      document.getElementById("lifeModeSelect").value = profile.lifeMode || "30000_days";
      document.getElementById("themeSelect").value = profile.theme || "light";
      if (profile.country) {
        countrySelect.value = profile.country;
      }

      // stats from other pages (dreams / reflections)
      const dreams = JSON.parse(localStorage.getItem("dreams")) || [];
      const reflections = JSON.parse(localStorage.getItem("reflections")) || [];
      const activeDreams = dreams.filter(d => d.status === "in_progress").length;
      const completedDreams = dreams.filter(d => d.status === "completed").length;
      document.getElementById("activeDreamsCount").textContent = activeDreams;
      document.getElementById("completedDreamsCount").textContent = completedDreams;
      document.getElementById("reflectionsCount").textContent = reflections.length;

      // referral section
      document.getElementById("refFriends").textContent = profile.referralFriends || 0;
      document.getElementById("refStars").textContent = (profile.referralFriends || 0) * 5;

      const path = window.location.pathname;
      const basePath = path.substring(0, path.lastIndexOf("/") + 1);
      const referralLink = window.location.origin + basePath + "?ref=" + profile.referralCode;
      document.getElementById("referralLinkInput").value = referralLink;

      updateLifeModeHint();
    }

    // Event listeners
    document.getElementById("nameInput").addEventListener("input", (e) => {
      profile.name = e.target.value;
      saveProfile();
      renderProfile();
    });

    document.getElementById("emailInput").addEventListener("input", (e) => {
      profile.email = e.target.value;
      saveProfile();
      renderProfile();
    });

    document.getElementById("birthInput").addEventListener("change", (e) => {
      profile.birthdate = e.target.value;
      saveProfile();
    });

    document.getElementById("sexSelect").addEventListener("change", (e) => {
      profile.sex = e.target.value;
      saveProfile();
      updateLifeModeHint();
    });

    countrySelect.addEventListener("change", (e) => {
      profile.country = e.target.value;
      saveProfile();
      updateLifeModeHint();
    });

    document.getElementById("lifeModeSelect").addEventListener("change", (e) => {
      profile.lifeMode = e.target.value;
      saveProfile();
      updateLifeModeHint();
    });

    document.getElementById("themeSelect").addEventListener("change", (e) => {
      profile.theme = e.target.value;
      saveProfile();
    });

    // Avatar upload
    document.getElementById("avatarWrapper").addEventListener("click", () => {
      document.getElementById("avatarInput").click();
    });

    document.getElementById("avatarInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        profile.avatar = reader.result;
        saveProfile();
        renderProfile();
      };
      reader.readAsDataURL(file);
    });

    // Referral copy / share
    const copyBtn = document.getElementById("copyReferralBtn");
    copyBtn.addEventListener("click", () => {
      const input = document.getElementById("referralLinkInput");
      input.select();
      input.setSelectionRange(0, 99999);
      try {
        document.execCommand("copy");
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy"), 2000);
      } catch {
        alert("Unable to copy");
      }
    });

    document.getElementById("shareReferralBtn").addEventListener("click", async () => {
      const link = document.getElementById("referralLinkInput").value;
      const text =
        "Every day counts. Join me on DAYLIFE and start making your days matter!";
      if (navigator.share) {
        try {
          await navigator.share({ title: "Join DAYLIFE", text, url: link });
        } catch (e) {
          console.log("Share cancelled");
        }
      } else {
        copyBtn.click();
      }
    });

    // Logout = reset local data
    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (confirm("Cela va effacer vos donnÃ©es locales sur cet appareil. Continuer ?")) {
        localStorage.clear();
        window.location.href = "index.html";
      }
    });

    renderProfile();
  </script>
</body>
</html>
